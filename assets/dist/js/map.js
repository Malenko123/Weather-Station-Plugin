class h{constructor(t){this.weatherStationMap=t,this.bookmarks=this.loadBookmarks(),this.showingBookmarks=!1,this.bookmarkedStations=[],this.bookmarksContainer=null,this.myLocationsBtn=null}initMyLocations(){const t=document.createElement("div");t.className="ws-my-locations-wrapper",this.myLocationsBtn=document.createElement("button"),this.myLocationsBtn.className="ws-my-locations-btn ws-btn",this.myLocationsBtn.innerHTML='<span class="ws-my-locations-text">My Locations</span>',this.myLocationsBtn.addEventListener("click",()=>this.toggleBookmarksView()),t.appendChild(this.myLocationsBtn);const e=this.weatherStationMap.sidebarElement.querySelector(".sidebar-content");e&&e.appendChild(t)}isBookmarked(t){return this.bookmarks.includes(t)}toggleBookmark(t){const e=this.bookmarks.indexOf(t);e>-1?this.bookmarks.splice(e,1):this.bookmarks.push(t),this.saveBookmarks()}toggleBookmarksView(){this.showingBookmarks=!this.showingBookmarks,this.showingBookmarks?(this.showBookmarks(),this.myLocationsBtn.innerHTML='<span class="ws-my-locations-text">Close</span>',this.myLocationsBtn.classList.add("ws-showing-bookmarks")):(this.hideBookmarks(),this.myLocationsBtn.innerHTML='<span class="ws-my-locations-text">My Locations</span>',this.myLocationsBtn.classList.remove("ws-showing-bookmarks"))}showBookmarks(){this.bookmarkedStations=this.getBookmarkedStations();const{descriptionElement:t}=this.weatherStationMap;if(t&&(t.style.display="none"),this.weatherStationMap.updateSidebarHeaderVisibility(!1),this.bookmarksContainer=document.createElement("div"),this.bookmarksContainer.className="ws-bookmarks-container",this.bookmarkedStations.length===0)this.bookmarksContainer.innerHTML=`
                <div class="ws-no-bookmarks">
                    <p>No saved locations yet</p>
                    <p>Click the bookmark icon on any weather station to save it here</p>
                </div>
            `;else{let i='<div class="ws-bookmarks-list">';this.bookmarkedStations.forEach(a=>{i+=`
                    <div class="ws-weather-card" data-station-id="${a.id}">
                        <div class="ws-weather-header">
                            <h3 class="ws-location-name">${a.name||"Loading..."}</h3>
                        </div>
                        <div class="ws-weather-details">
                            <div class="weather-loading">
                                <div class="loading-spinner"></div>
                                <p>Loading weather data...</p>
                            </div>
                        </div>
                        <button class="ws-bookmark-remove" data-station-id="${a.id}">✕</button>
                    </div>
                `}),i+="</div>",this.bookmarksContainer.innerHTML=i,this.bookmarkedStations.forEach(a=>{this.fetchFreshWeatherData(a.id,a.lat,a.lng)}),this.addBookmarkItemListeners()}const e=this.weatherStationMap.sidebarElement.querySelector(".sidebar-content");e&&e.appendChild(this.bookmarksContainer),this.weatherStationMap.addMapOverlay()}fetchFreshWeatherData(t,e,i){fetch(window.weatherStationData.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"get_weather_data",nonce:window.weatherStationData.nonce,station_id:t,lat:e,lng:i,units:this.weatherStationMap.currentUnit})}).then(a=>a.json()).then(a=>{a.success?this.updateBookmarkCard(t,a.data):this.updateBookmarkCard(t,null,"Failed to load data")}).catch(a=>{console.error("Fetch error for bookmark:",a),this.updateBookmarkCard(t,null,"Network error")})}updateBookmarkCard(t,e,i=null){const a=this.bookmarksContainer.querySelector(`.ws-weather-card[data-station-id="${t}"]`);if(!a)return;const o=this.weatherStationMap.currentUnit==="metric"?"°C":"°F";if(i){a.querySelector(".ws-weather-details").innerHTML=`
                <div class="weather-error">
                    <p>${i}</p>
                </div>
            `;return}if(e){a.querySelector(".ws-location-name").textContent=e.name||"Unknown";const n=`
                <div class="ws-detail"><span class="ws-label">Weather: </span><span class="ws-value">${e.weather[0].main} - ${e.weather[0].description}</span></div>
                <div class="ws-detail"><span class="ws-label">Temp: </span><span class="ws-value">${Math.round(e.main.temp)}${o} / Feels like ${Math.round(e.main.feels_like)}${o}</span></div>
                <div class="ws-detail"><span class="ws-label">Pressure: </span><span class="ws-value">${e.main.pressure} hPa</span></div>
                <div class="ws-detail"><span class="ws-label">Humidity: </span><span class="ws-value">${e.main.humidity}%</span></div>
            `;a.querySelector(".ws-weather-details").innerHTML=n}}hideBookmarks(){const{descriptionElement:t,activeStation:e}=this.weatherStationMap;if(e?t&&(t.style.display="none"):t&&(t.style.display=""),this.bookmarksContainer&&(this.bookmarksContainer.remove(),this.bookmarksContainer=null),this.myLocationsBtn.innerHTML='<span class="ws-my-locations-text">My Locations</span>',this.myLocationsBtn.classList.remove("ws-showing-bookmarks"),this.showingBookmarks=!1,this.weatherStationMap.removeMapOverlay(),this.weatherStationMap.currentWeatherData)this.weatherStationMap.updateSidebarWithWeatherData(this.weatherStationMap.currentWeatherData);else if(e){const i=window.weatherStationData.stations.find(a=>a.id===e);i&&this.weatherStationMap.fetchWeatherData(i.id,i.lat,i.lng)}this.weatherStationMap.updateBookmarkButtonState()}addBookmarkItemListeners(){this.bookmarksContainer.querySelectorAll(".ws-bookmark-remove").forEach(t=>{t.replaceWith(t.cloneNode(!0))}),this.bookmarksContainer.querySelectorAll(".ws-location-name").forEach(t=>{t.replaceWith(t.cloneNode(!0))}),this.bookmarksContainer.querySelectorAll(".ws-bookmark-remove").forEach(t=>{t.addEventListener("click",e=>{const i=parseInt(e.currentTarget.dataset.stationId,10);this.removeBookmark(i)})}),this.bookmarksContainer.addEventListener("click",t=>{if(t.target.classList.contains("ws-location-name")){const e=t.target.closest(".ws-weather-card"),i=e.querySelector(".ws-weather-details"),a=parseInt(e.dataset.stationId,10);if(!i)return;if(i.style.display==="none"||i.style.display===""){this.bookmarksContainer.querySelectorAll(".ws-weather-details").forEach(s=>{s!==i&&(s.style.maxHeight="0px",setTimeout(()=>{s.style.display="none"},300))}),this.bookmarksContainer.querySelectorAll(".ws-weather-card").forEach(s=>s.classList.remove("active","inactive")),i.style.display="block",i.style.maxHeight=i.scrollHeight+"px",i.style.transition="max-height 0.3s ease",e.classList.add("active"),this.bookmarksContainer.querySelectorAll(".ws-weather-card").forEach(s=>{s!==e&&s.classList.add("inactive")}),this.weatherStationMap.removeMapOverlay();const n=window.weatherStationData.stations.find(s=>s.id===a);if(n){this.weatherStationMap.map.setView([n.lat,n.lng],13);const s=this.weatherStationMap.markers.find(l=>l.options.stationId===a);s&&s.openPopup()}history.pushState?history.pushState(null,null,`#${a}`):location.hash=`#${a}`}else i.style.maxHeight="0px",setTimeout(()=>{i.style.display="none"},300),e.classList.remove("active"),this.bookmarksContainer.querySelector(".ws-weather-card.active")||this.bookmarksContainer.querySelectorAll(".ws-weather-card").forEach(s=>s.classList.remove("inactive")),this.weatherStationMap.addMapOverlay()}}),this.bookmarksContainer.querySelectorAll(".ws-weather-details").forEach(t=>{t.style.display="none",t.style.overflow="hidden",t.style.maxHeight="0"})}removeBookmark(t){this.bookmarks=this.bookmarks.filter(a=>a!==t),this.saveBookmarks();const e=this.bookmarksContainer.querySelector(`.ws-weather-card[data-station-id="${t}"]`);e&&e.remove(),this.bookmarks.length===0&&(this.bookmarksContainer.innerHTML=`
                <div class="ws-no-bookmarks">
                    <p>No saved locations yet</p>
                    <p>Click the bookmark icon on any weather station to save it here</p>
                </div>`);const i=this.weatherStationMap.sidebarElement.querySelector(`.js-ws-bookmark-btn[data-station-id="${t}"]`);if(i){i.classList.remove("ws-bookmarked");const a=i.querySelector("img");a&&(a.src=window.weatherStationData.bookmark_icon,a.alt="Bookmark")}}updateBookmarksView(){this.bookmarksContainer.querySelectorAll(".ws-bookmark-item").length===0&&(this.bookmarksContainer.innerHTML=`
                <div class="ws-no-bookmarks">
                    <p>No saved locations yet</p>
                    <p>Click the bookmark icon on any weather station to save it here</p>
                </div>`)}getBookmarkedStations(){var t;return(t=window.weatherStationData)!=null&&t.stations?window.weatherStationData.stations.filter(e=>this.bookmarks.includes(e.id)):[]}loadBookmarks(){try{const t=localStorage.getItem("ws_bookmarks");return t?JSON.parse(t):[]}catch(t){return console.error("Error loading bookmarks:",t),[]}}saveBookmarks(){try{localStorage.setItem("ws_bookmarks",JSON.stringify(this.bookmarks))}catch(t){console.error("Error saving bookmarks:",t)}}}class c{constructor(){if(!window.weatherStationData||!window.weatherStationData.stations){console.error("Weather station data not available");return}this.map=null,this.markers=[],this.activeStation=null,this.currentUnit="metric",this.currentWeatherData=null,this.sidebarElement=null,this.weatherContainer=null,this.descriptionElement=null,this.bookmarkManager=new h(this),this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.setupMap()):this.setupMap()}setupMap(){const t=document.getElementById("weather-station-map");if(!t){console.warn("Map container not found");return}"scrollRestoration"in history&&(history.scrollRestoration="manual"),this.initMap(t),this.initSidebar(),this.addStationsToMap(),this.setupEventListeners(),this.checkUrlForStation()}initMap(t){this.map=L.map(t).setView([51.505,-.09],3),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:18}).addTo(this.map)}initSidebar(){var i,a;const e=document.getElementById("weather-station-map").closest(".weather-station-app");if(e&&(this.sidebarElement=e.querySelector(".weather-station-sidebar")),this.sidebarElement||(console.warn("Sidebar element not found, creating temporary one"),this.createTemporarySidebar()),this.descriptionElement=(i=this.sidebarElement)==null?void 0:i.querySelector(".sidebar-description"),this.descriptionElement&&window.weatherStationData.sidebar_description&&(this.descriptionElement.innerHTML=window.weatherStationData.sidebar_description),this.weatherContainer=(a=this.sidebarElement)==null?void 0:a.querySelector(".weather-data-container"),!this.weatherContainer&&this.sidebarElement){this.weatherContainer=document.createElement("div"),this.weatherContainer.className="weather-data-container";const o=this.sidebarElement.querySelector(".sidebar-content");o?o.appendChild(this.weatherContainer):this.sidebarElement.appendChild(this.weatherContainer)}this.bookmarkManager.initMyLocations()}createTemporarySidebar(){this.sidebarElement=document.createElement("div"),this.sidebarElement.className="weather-station-sidebar",this.weatherContainer=document.createElement("div"),this.weatherContainer.className="weather-data-container";const t=document.createElement("div");t.className="sidebar-content",t.appendChild(this.weatherContainer),this.sidebarElement.appendChild(t),Object.assign(this.sidebarElement.style,{position:"fixed",top:"20px",right:"20px",background:"#28282C",color:"white",padding:"20px",borderRadius:"8px",zIndex:"1000",maxWidth:"300px"}),document.body.appendChild(this.sidebarElement)}closeSidebar(){this.sidebarElement&&this.sidebarElement.classList.remove("has-active-station"),this.activeStation=null,this.currentWeatherData=null,this.markers.forEach(t=>{var e;(e=t._icon)==null||e.classList.remove("active")}),window.history.pushState({},"",window.location.pathname)}updateBookmarkButtonState(){if(!this.weatherContainer||!this.activeStation)return;const t=this.bookmarkManager.isBookmarked(this.activeStation),e=this.weatherContainer.querySelector(".js-ws-bookmark-btn");if(e){const i=t?window.weatherStationData.bookmark_filled_icon:window.weatherStationData.bookmark_icon;t?e.classList.add("ws-bookmarked"):e.classList.remove("ws-bookmarked");const a=e.querySelector("img");a&&(a.src=i,a.alt=t?"Bookmarked":"Bookmark")}}addStationsToMap(){const t=L.icon({iconUrl:"data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="#4CAF50" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>'),iconSize:[24,24],iconAnchor:[12,24],popupAnchor:[0,-24],className:"weather-station-marker"});window.weatherStationData.stations.forEach(e=>{const i=L.marker([e.lat,e.lng],{icon:t,stationId:e.id}).addTo(this.map);i.on("click",()=>this.activateStation(e.id)),this.markers.push(i)})}activateStation(t){const e=window.weatherStationData.stations.find(i=>i.id===t);e&&(this.showWeatherData(t,e.lat,e.lng),this.activeStation=t,setTimeout(()=>{this.map.invalidateSize(),this.map.flyTo([e.lat,e.lng],13,{animate:!0,duration:.7,paddingTopLeft:[300,0]}),this.map.once("moveend",()=>{const i=document.getElementById("weather-station-app");if(i){const a=i.getBoundingClientRect().top+window.scrollY;window.scrollTo({top:a,behavior:"smooth"}),setTimeout(()=>{window.history.pushState({},"",`${window.location.pathname}#${t}`)},200)}})},150))}showWeatherData(t,e,i){this.sidebarElement&&this.sidebarElement.classList.add("has-active-station"),this.descriptionElement&&(this.descriptionElement.style.display="none"),this.fetchWeatherData(t,e,i)}fetchWeatherData(t,e,i){this.weatherContainer&&(this.weatherContainer.innerHTML='<div class="weather-loading"><div class="loading-spinner"></div><p>Loading weather data...</p></div>'),fetch(window.weatherStationData.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"get_weather_data",nonce:window.weatherStationData.nonce,station_id:t,lat:e,lng:i,units:this.currentUnit})}).then(a=>a.json()).then(a=>{if(a.success)this.currentWeatherData=a.data,this.updateSidebarWithWeatherData(a.data);else throw new Error(a.data||"Unknown API error")}).catch(a=>{console.error("Fetch error:",a),this.updateSidebarWithError("Network error: "+a.message)})}updateSidebarWithWeatherData(t){if(!this.weatherContainer)return;this.updateSidebarHeaderVisibility(!1);const e=this.currentUnit==="metric"?"°C":"°F";this.currentUnit;const i=this.bookmarkManager.isBookmarked(this.activeStation),a=i?window.weatherStationData.bookmark_filled_icon:window.weatherStationData.bookmark_icon,o=`
            <div class="ws-weather-card">
                <div class="ws-weather-header">
                    <div class="ws-weather-header-inner">
                        <div class="ws-temperature-controls">
                            <button class="ws-btn ${this.currentUnit==="metric"?"ws-btn-active":""}" data-unit="metric">Celsius</button>
                            <span class="ws-unit-separator">/</span>
                            <button class="ws-btn ${this.currentUnit==="imperial"?"ws-btn-active":""}" data-unit="imperial">Fahrenheit</button>
                        </div>
                        <div class="ws-bookmark-locations">
                            <button class="js-ws-bookmark-btn ${i?"ws-bookmarked":""}" data-station-id="${this.activeStation}">
                                <img src="${a}" class="ws-bookmark-icon" alt="${i?"Bookmarked":"Bookmark"}" width="17" height="17" />
                            </button>
                        </div>
                    </div>
                    <h3 class="ws-location-name">${t.name||"Weather Station"}</h3>  
                </div>
                <div class="ws-weather-details">
                    <div class="ws-detail"><span class="ws-label">Weather: </span><span class="ws-value">${t.weather[0].main} - ${t.weather[0].description}</span></div>
                    <div class="ws-detail"><span class="ws-label">Temp: </span><span class="ws-value">${Math.round(t.main.temp)}${e} / Feels like ${Math.round(t.main.feels_like)}${e}</span></div>
                    <div class="ws-detail"><span class="ws-label">Pressure: </span><span class="ws-value">${t.main.pressure} hPa</span></div>
                    <div class="ws-detail"><span class="ws-label">Humidity: </span><span class="ws-value">${t.main.humidity}%</span></div>
                </div>
            </div>`;this.weatherContainer.innerHTML=o,this.addUnitButtonListeners(),this.addBookmarkButtonListeners()}updateSidebarWithError(t){this.weatherContainer&&(this.weatherContainer.innerHTML=`<div class="weather-data-active"><div class="weather-header"><h3>Error</h3></div><div class="weather-description">Failed to load weather data: ${t}</div></div>`)}addBookmarkButtonListeners(){const t=this.weatherContainer.querySelector(".js-ws-bookmark-btn");if(!t)return;const e=t.cloneNode(!0);t.parentNode.replaceChild(e,t),e.addEventListener("click",i=>{const a=parseInt(i.currentTarget.dataset.stationId,10);this.bookmarkManager.toggleBookmark(a),this.currentWeatherData?this.updateSidebarWithWeatherData(this.currentWeatherData):this.updateBookmarkButtonState()})}addUnitButtonListeners(){this.weatherContainer.querySelectorAll(".ws-temperature-controls .ws-btn").forEach(t=>{t.addEventListener("click",e=>{const i=e.currentTarget.dataset.unit;if(i&&i!==this.currentUnit){this.currentUnit=i;const a=window.weatherStationData.stations.find(o=>o.id===this.activeStation);a&&this.fetchWeatherData(this.activeStation,a.lat,a.lng)}})})}setupEventListeners(){this.map.on("click",t=>{const e=this.findClosestStation(t.latlng);e?this.activateStation(e.id):console.log("No station within threshold")}),window.addEventListener("popstate",()=>this.checkUrlForStation())}findClosestStation(t){let e=null,i=1/0;return window.weatherStationData.stations.forEach(a=>{const o=L.latLng(a.lat,a.lng),n=this.map.distance(t,o);n<i&&(i=n,e=a)}),e}checkUrlForStation(){const t=parseInt(window.location.hash.substring(1),10);isNaN(t)?this.closeSidebar():this.activateStation(t)}showStationWeather(t){window.weatherStationData.stations.find(i=>i.id===t)&&this.activateStation(t)}addMapOverlay(){if(this.mapOverlay)this.mapOverlay.classList.add("active");else{this.mapOverlay=document.createElement("div"),this.mapOverlay.className="ws-map-overlay";const t=document.getElementById("weather-station-map");t&&(t.style.position="relative",t.appendChild(this.mapOverlay),this.mapOverlay.offsetWidth,setTimeout(()=>{this.mapOverlay.classList.add("active")},10))}}removeMapOverlay(){this.mapOverlay&&(this.mapOverlay.classList.remove("active"),setTimeout(()=>{this.mapOverlay&&this.mapOverlay.parentNode&&(this.mapOverlay.parentNode.removeChild(this.mapOverlay),this.mapOverlay=null)},400))}updateSidebarHeaderVisibility(t){const e=this.sidebarElement.querySelector(".sidebar-header");e&&(e.style.display=t?"":"none")}}new c;
